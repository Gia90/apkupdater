package com.apkupdater.adapter;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

import android.app.Activity;
import android.content.Context;
import android.support.annotation.NonNull;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ArrayAdapter;

import com.apkupdater.model.LogMessage;
import com.apkupdater.util.MyBus;
import com.apkupdater.view.LogView;
import com.apkupdater.view.LogView_;
import com.squareup.otto.Subscribe;

import org.androidannotations.annotations.AfterViews;
import org.androidannotations.annotations.Bean;
import org.androidannotations.annotations.EBean;
import org.androidannotations.annotations.RootContext;
import org.androidannotations.annotations.UiThread;

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

@EBean
public class LogAdapter
	extends ArrayAdapter<LogMessage>
{
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	@RootContext
	Activity context;

	@Bean
	MyBus mBus;

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	public LogAdapter(
		Context context
	) {
		super(context, 0);
	}

	@AfterViews
	public void init(
	) {
		mBus.register(this);
	}

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	@Subscribe
	public void onLogMessage(
		LogMessage m
	) {
		add(m);
	}

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	@Override
	@NonNull
	public View getView(
		int position,
		View convertView,
		@NonNull ViewGroup parent
	) {
		LogView log;

		if (convertView == null) {
			log = LogView_.build(context);
		} else {
			log = (LogView) convertView;
		}

		log.bind(getItem(position));

		return log;
	}

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	@UiThread(propagation = UiThread.Propagation.REUSE)
	public void log(
		String title,
		String message,
		int severity
	) {
		add(new LogMessage(title, message, severity));
	}

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	@Override
	public void notifyDataSetChanged(
	) {
		super.notifyDataSetChanged();
	}

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	public LogMessage[] getValues(
	) {
		LogMessage [] values = new LogMessage[getCount()];
		for (int i = 0; i < getCount(); i++) {
			values[i] = getItem(i);
		}
		return values;
	}

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

